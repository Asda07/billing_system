{% extends "base.html" %}

{% block title %}Purchase History{% endblock %}

{% block content %}
<h2>Purchase History</h2>

<!-- Search by Email -->
<form method="get" class="mb-20">
    <div class="form-group">
        <label>Customer Email</label>
        <input type="email" name="email" value="{{ email }}" placeholder="Enter customer email" style="width: 320px;">
        <button type="submit" class="btn btn-primary">Search</button>
    </div>
</form>

{% if email %}
    {% if orders %}
    <h3>Orders for {{ email }}</h3>
    <table>
        <thead>
            <tr>
                <th style="width: 5%;" class="text-center">#</th>
                <th style="width: 20%;">Order Code</th>
                <th style="width: 20%;">Date</th>
                <th style="width: 15%;" class="text-right">Total Amount</th>
                <th style="width: 15%;" class="text-right">Amount Paid</th>
                <th style="width: 10%;"></th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr {% if selected_order and selected_order.code == order.code %}style="background: #e8f4fd;"{% endif %}>
                <td class="text-center">{{ forloop.counter }}</td>
                <td>{{ order.code }}</td>
                <td>{{ order.purchase_date|date:"d-m-Y H:i" }}</td>
                <td class="text-right">{{ order.total_amount }}</td>
                <td class="text-right">{{ order.amount_paid }}</td>
                <td class="text-center">
                    <a href="?email={{ email }}&order={{ order.code }}" class="btn btn-sm btn-primary">View</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Selected Order Details -->
    {% if selected_order %}
    <h3>Items in Order #{{ selected_order.code }}</h3>
    <table>
        <thead>
            <tr>
                <th class="text-center" style="width: 5%;">S.No</th>
                <th class="text-center" style="width: 15%;">Product ID</th>
                <th class="text-center" style="width: 12%;">Unit Price</th>
                <th class="text-center" style="width: 8%;">Qty</th>
                <th class="text-center" style="width: 15%;">Purchase Price</th>
                <th class="text-center" style="width: 8%;">Tax %</th>
                <th class="text-center" style="width: 15%;">Tax Amount</th>
                <th class="text-center" style="width: 15%;">Total Price</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td class="text-center">{{ forloop.counter }}</td>
                <td class="text-center">{{ item.product.code }}</td>
                <td class="text-right">{{ item.unit_price }}</td>
                <td class="text-center">{{ item.quantity }}</td>
                <td class="text-right">{{ item.subtotal }}</td>
                <td class="text-center">{{ item.tax_percentage }}%</td>
                <td class="text-right">{{ item.tax_amount }}</td>
                <td class="text-right">{{ item.total }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <table style="width: 50%;">
        <tr>
            <td><strong>Total Price (without tax)</strong></td>
            <td class="text-right">{{ selected_order.total_before_tax }}</td>
        </tr>
        <tr>
            <td><strong>Total Tax Payable</strong></td>
            <td class="text-right">{{ selected_order.total_tax }}</td>
        </tr>
        <tr>
            <td><strong>Net Price (Rounded Down)</strong></td>
            <td class="text-right">{{ selected_order.total_amount }}</td>
        </tr>
        <tr>
            <td><strong>Amount Paid</strong></td>
            <td class="text-right">{{ selected_order.amount_paid }}</td>
        </tr>
        <tr style="background: #f2f2f2;">
            <td><strong>Balance to Customer</strong></td>
            <td class="text-right" style="font-weight: bold;">{{ selected_order.change_given }}</td>
        </tr>
    </table>
    {% endif %}

    {% else %}
    <p>No completed orders found for <strong>{{ email }}</strong>.</p>
    {% endif %}
{% endif %}
{% endblock %}
